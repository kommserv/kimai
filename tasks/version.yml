---
- name: Check the installed version of Kimai
  block:

    - name: "Stat {{ kimai_docroot | dirname }}/bin/console"
      stat:
        path: "{{ kimai_docroot | dirname }}/bin/console"
      register: kimai_console

    - name: Check the verson of Kimai when the console is present
      block:

        - name: Check which version of Kimai is installed
          command: bin/console --no-ansi -n kimai:version --short
          args:
            chdir: "{{ kimai_docroot | dirname }}"
          check_mode: false
          changed_when: false
          register: kimai_install_check
          failed_when: kimai_install_check.rc is not regex('^0$|^1$|^127$')
          become: true
          become_user: "{{ kimai_user }}"

        - name: Set a variable for the installed version of Kimai
          set_fact:
            kimai_installed: "{{ kimai_install_check.stdout | trim }}"
          when: ( kimai_install_check is defined ) and ( kimai_install_check.rc == 0 )

      when: kimai_console.stat.exists

  tags:
    - kimai
...
